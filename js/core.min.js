function calcTranstions(){let t=ref_REDB_transitions,e=formRef.data.jo2,o=formRef.data.jo4,a=formRef.data.jo6;if("JO"!=formRef.data.radioInputType){let i=[[0,0,0],[0,0,0],[0,0,0]],d=[0,0,0];for(let n=0;n<formRef.data.dataGrid.length;n++){let r=formRef.data.dataGrid[n];r.include&&(i[0][0]+=2*Number(r.u2)*Number(r.u2),i[0][1]+=2*Number(r.u2)*Number(r.u4),i[0][2]+=2*Number(r.u2)*Number(r.u6),i[1][0]+=2*Number(r.u4)*Number(r.u2),i[1][1]+=2*Number(r.u4)*Number(r.u4),i[1][2]+=2*Number(r.u4)*Number(r.u6),i[2][0]+=2*Number(r.u6)*Number(r.u2),i[2][1]+=2*Number(r.u6)*Number(r.u4),i[2][2]+=2*Number(r.u6)*Number(r.u6),d[0]+=2*Number(r.u2)*Number(r.sExp),d[1]+=2*Number(r.u4)*Number(r.sExp),d[2]+=2*Number(r.u6)*Number(r.sExp))}let l=math.multiply(math.inv(i),d);e=l[0],o=l[1],a=l[2]}var s="<table class='styled-table' style='width:100%'>",$="data:text/csv;charset=utf-8,Transition eState,Transition gState,Wavelength (nm),(ED),S(MD),A(ED),A(MD),Beta,Lifetime (ms)\n";s+="<thead><tr><th colspan='3'>Transition</th><th>Wavelength (nm)</th><th>S(ED)</th><th>S(MD)</th><th>A(ED)</th><th>A(MD)</th><th>Beta</th><th>Lifetime (ms)</th></tr></thead><tbody>";for(var c=t[0].excitedState,u=0,_=0,h=0,p=[],m=0;m<t.length;m++){let f=ref_REDB.findIndex(e=>e.excitedState==t[m].excitedState),g=ref_REDB.findIndex(e=>e.excitedState==t[m].groundState);if(void 0==f||void 0==g){console.log("State index not found",f,g);continue}let w=formRef.data.dataGrid[f].barycenter,j=formRef.data.dataGrid[g].barycenter;if(void 0==w||void 0==j){console.log("State value not found",w,j);continue}t[m].wavenumber=w-j;let v=Math.sqrt(formRef.data.const_sellmeier+formRef.data.a_sellmeier*math.pow(1e4/t[m].wavenumber,2)/(math.pow(1e4/t[m].wavenumber,2)-formRef.data.b_sellmeier)+formRef.data.c_sellmeier*math.pow(1e4/t[m].wavenumber,2)/(math.pow(1e4/t[m].wavenumber,2)-formRef.data.d_sellmeier)),b=t[m].l2s*math.pow(constE*constH/(4*constPi*constM*constC),2),x=t[m].u2*e+t[m].u4*o+t[m].u6*a,A=64*math.pow(constPi,4)*math.pow(constE,2)/(3*constH),S=A*v*math.pow((v*v+2)/3,2)*x/((2*t[m].eState+1)*math.pow(1/t[m].wavenumber,3)),P=64*math.pow(constPi,4)*math.pow(v,3)*b/(3*constH*math.pow(1/t[m].wavenumber,3)*(2*t[m].eState+1)),D=S+P,y=1e7/t[m].wavenumber;if(p.push({eState:t[m].excitedState,gState:t[m].groundState,wl:y,rowSMD:b,rowSED:x,rowAED:S,rowAMD:P,beta:0,tRad:1e3/D}),c==t[m].excitedState)u+=D,h++;else{_=0;for(var M=0;M<h;M++)_+=p[m-1-M].rowAED+p[m-1-M].rowAMD,p[m-1-M].beta=(p[m-1-M].rowAED+p[m-1-M].rowAMD)/u,p[m-1-M].tRad=1e3/_;u=D,c=t[m].excitedState,h=1}}_=0;for(var M=0;M<h;M++)_+=p[m-1-M].rowAED+p[m-1-M].rowAMD,p[t.length-1-M].beta=(p[t.length-1-M].rowAED+p[t.length-1-M].rowAMD)/u,p[m-1-M].tRad=1e3/_;for(var m=0;m<p.length;m++)$+=p[m].eState+","+p[m].gState+","+p[m].wl.toFixed(1)+","+p[m].rowSED.toPrecision(3)+","+p[m].rowSMD.toPrecision(3)+","+p[m].rowAED.toPrecision(3)+","+p[m].rowAMD.toPrecision(3)+","+p[m].beta.toPrecision(3)+","+p[m].tRad.toPrecision(3)+"\n",s+="<tr><td>"+p[m].eState+"</td><td>-</td><td>"+p[m].gState+"</td><td>"+p[m].wl.toFixed(1)+"</td><td>"+p[m].rowSED.toPrecision(3)+"</td><td>"+p[m].rowSMD.toPrecision(3)+"</td><td>"+p[m].rowAED.toPrecision(3)+"</td><td>"+p[m].rowAMD.toPrecision(3)+"</td><td>"+p[m].beta.toPrecision(3)+"</td><td>"+p[m].tRad.toPrecision(3)+"</td></tr>";s+="</tbody></table>",formRef.getComponent("statTransitionsReport").component.content=s,(linkTransitions=document.createElement("a")).setAttribute("href",encodeURI($)),""!=formRef.data.sampleName?linkTransitions.setAttribute("download",formRef.data.sampleName+"_transitions_export.csv"):linkTransitions.setAttribute("download","transitions_export.csv"),document.body.appendChild(linkTransitions)}function calcCombinations(){document.getElementById("overlayloading").style.display="block",showProgressBar(),calcCombinationsWorker()}function calcCombinationsWorker(){let t=0,e="<table class='styled-table' style='width:100%'>",o=ref_REDB.reduce((e,o,a)=>(formRef.data.dataGrid[a].include&&(t++,e.push(a)),e),[]),a=t-1,i=0;if(t>4){let d=new combinationsGen(o),n=0,r="data:text/csv;charset=utf-8,no,transitions_included,transitions_included_no,JO2,JO4,JO6\n";e+="<thead><tr><th></th><th colspan='"+t+"'>Transitions included</th><th>JO2</th><th>JO4</th><th>JO6</th><th>JO2/JO4</th><th>JO2/JO6</th><th>JO4/JO6</th></tr></thead><tbody>";for(var l=[],s={jo2:[],jo4:[],jo6:[],jo2jo4:[],jo2jo6:[],jo4jo6:[]},$={jo2:[],jo4:[],jo6:[],jo2jo4:[],jo2jo6:[],jo4jo6:[]},c=0;c<1e10&&!(a<4);)c+=math.factorial(t)/(math.factorial(a)*math.factorial(t-a)),a--;for(progressPercent=0,a=t-1;i<1e10&&!(a<4);){for(i=math.factorial(t)/(math.factorial(a)*math.factorial(t-a)),_combinations=d.combinations(a);;){let u=[];if(0==n)u.value=o;else if((u=_combinations.next()).done)break;n++;let _=Math.round(n/c*40);_>progressPercent&&updateProgressBar(progressPercent=_);let h=[[0,0,0],[0,0,0],[0,0,0]],p=[0,0,0];e=e+"<tr><td>"+n+"</td>";let m=0,f="",g="",w="";for(let j=0;j<ref_REDB.length;j++)if(u.value.includes(j)){m++;let v=Number(formRef.data.dataGrid[j].u2),b=Number(formRef.data.dataGrid[j].u4),x=Number(formRef.data.dataGrid[j].u6),A=Number(formRef.data.dataGrid[j].sExp);h[0][0]+=2*v*v,h[0][1]+=2*v*b,h[0][2]+=2*v*x,h[1][0]+=2*b*v,h[1][1]+=2*b*b,h[1][2]+=2*b*x,h[2][0]+=2*x*v,h[2][1]+=2*x*b,h[2][2]+=2*x*x,p[0]+=2*v*A,p[1]+=2*b*A,p[2]+=2*x*A,e+=`<td>${ref_REDB[j].excitedStateFormatted}</td>`,f+=`${ref_REDB[j].excitedStateFormatted} `,g+=`${ref_REDB[j].excitedState} `,w+=`${j} `}l.push(f);for(let S=0;S<t-m;S++)e+="<td></td>";let P=0,D=!1;try{P=math.multiply(math.inv(h),p)}catch(y){D=!0,console.log(y.message)}D?(r+=`${n},${g},${w},N/A,N/A,N/A`,e+="<td>N/A</td><td>N/A</td><td>N/A</td><td>N/A</td><td>N/A</td><td>N/A</td></tr>"):(mtxCacheOutput=P,r+=`${n},${g},${w},${mtxCacheOutput[0]},${mtxCacheOutput[1]},${mtxCacheOutput[2]}`,$.jo2.push(mtxCacheOutput[0]),$.jo4.push(mtxCacheOutput[1]),$.jo6.push(mtxCacheOutput[2]),s.jo2.push({x:n,y:mtxCacheOutput[0]}),s.jo4.push({x:n,y:mtxCacheOutput[1]}),s.jo6.push({x:n,y:mtxCacheOutput[2]}),s.jo2jo4.push({x:n,y:mtxCacheOutput[0]/mtxCacheOutput[1]}),s.jo2jo6.push({x:n,y:mtxCacheOutput[0]/mtxCacheOutput[2]}),s.jo4jo6.push({x:n,y:mtxCacheOutput[1]/mtxCacheOutput[2]}),e+=`<td>${mtxCacheOutput[0].toPrecision(3)}</td><td>${mtxCacheOutput[1].toPrecision(3)}</td><td>${mtxCacheOutput[2].toPrecision(3)}</td><td>${(mtxCacheOutput[0]/mtxCacheOutput[1]).toPrecision(3)}</td><td>${(mtxCacheOutput[0]/mtxCacheOutput[2]).toPrecision(3)}</td><td>${(mtxCacheOutput[1]/mtxCacheOutput[2]).toPrecision(3)}</td></tr>`)}a--}e+="</tbody></table>",(linkCombinations=document.createElement("a")).setAttribute("href",encodeURI(r)),""!=formRef.data.sampleName?linkCombinations.setAttribute("download",formRef.data.sampleName+"_optimization_export.csv"):linkCombinations.setAttribute("download","optimization_export.csv"),document.body.appendChild(linkCombinations)}else e="Only 4 options entered",document.getElementById("overlayloading").style.display="none",hideProgressBar();formRef.getComponent("statJOreport").component.content=e;let M=["avg: "," cm\xb2 <i data-tooltip='Arithmetic mean' class='fa fa-question-circle text-muted' ref='tooltip' aria-expanded='false'></i>"],E=["median: "," cm\xb2 <i data-tooltip='Median' class='fa fa-question-circle text-muted' ref='tooltip' aria-expanded='false'></i>"],O=["median BP: "," cm\xb2 <i data-tooltip='Box plot median within 1.5 \xd7 25-75 percentile range' class='fa fa-question-circle text-muted' ref='tooltip' aria-expanded='false'></i>"],J=["s.d.: "," cm\xb2 <i data-tooltip='Standard deviation' class='fa fa-question-circle text-muted' ref='tooltip' aria-expanded='false'></i>"],N=["CV: ","% <i data-tooltip='Coefficient of variation' class='fa fa-question-circle text-muted' ref='tooltip' aria-expanded='false'></i>"];formRef.getComponent("htmldivtablecontainer").component.content="<table style='width:100%; text-align: center;'><tr><td>"+M[0]+getAvg($.jo2).toPrecision(3)+M[1]+"</td><td>"+M[0]+getAvg($.jo4).toPrecision(3)+M[1]+"</td><td>"+M[0]+getAvg($.jo6).toPrecision(3)+M[1]+"</td></tr><tr><td>"+E[0]+getMedian($.jo2).toPrecision(3)+E[1]+"</td><td>"+E[0]+getMedian($.jo4).toPrecision(3)+E[1]+"</td><td>"+E[0]+getMedian($.jo6).toPrecision(3)+E[1]+"</td></tr><tr><td>"+O[0]+getMedianBoxPlot($.jo2).toPrecision(3)+O[1]+"</td><td>"+O[0]+getMedianBoxPlot($.jo4).toPrecision(3)+O[1]+"</td><td>"+O[0]+getMedianBoxPlot($.jo6).toPrecision(3)+O[1]+"</td></tr><tr><td>"+J[0]+getStandardDeviation($.jo2).toPrecision(3)+J[1]+"</td><td>"+J[0]+getStandardDeviation($.jo4).toPrecision(3)+J[1]+"</td><td>"+J[0]+getStandardDeviation($.jo6).toPrecision(3)+J[1]+"</td></tr><tr><td>"+N[0]+(getStandardDeviation($.jo2)/getAvg($.jo2)*100).toPrecision(3)+N[1]+"</td><td>"+N[0]+(getStandardDeviation($.jo4)/getAvg($.jo4)*100).toPrecision(3)+N[1]+"</td><td>"+N[0]+(getStandardDeviation($.jo6)/getAvg($.jo6)*100).toPrecision(3)+N[1]+"</td></tr></table><br>",setTimeout(function(){progressPercent=40,renderGraph(s,l)},100)}function getStandardDeviation(t){let e=t.length,o=t.reduce((t,e)=>t+e)/e;return Math.sqrt(t.map(t=>Math.pow(t-o,2)).reduce((t,e)=>t+e)/e)}function getAvg(t){let e=t.length;return t.reduce((t,e)=>t+e)/e}function getMedian(t){let e=t.slice().sort((t,e)=>t-e),o=e.length,a=Math.floor(o/2);return o%2==0?(e[a-1]+e[a])/2:e[a]}function getMedianBoxPlot(t){let e=t.slice().filter(t=>t>=0),o=e.sort((t,e)=>t-e),a=o.length,i=o[Math.ceil(.25*(a-1))],d=o[Math.ceil(.75*(a-1))],n=d-i,r=i-1.5*n<0?0:i-1.5*n,l=d+1.5*n,s=e.filter(t=>t>=r&&t<=l);return getMedian(s)}class combinationsGen{constructor(t){this.elements=t}*combinations(t,e=!1,o=0,a=[]){let i=this.elements.length;for(let d=o;d<i;d++)a.push(this.elements[d]),a.length===t?yield a:yield*this.combinations(t,e,!0===e?d:d+1,a),a.pop()}}