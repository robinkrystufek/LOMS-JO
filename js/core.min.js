function calcTranstions(){let t=ref_REDB_transitions,e=formRef.data.jo2,o=formRef.data.jo4,i=formRef.data.jo6;if("JO"!=formRef.data.radioInputType){let a=[[0,0,0],[0,0,0],[0,0,0]],n=[0,0,0];for(let d=0;d<formRef.data.dataGrid.length;d++){let r=formRef.data.dataGrid[d];r.include&&(a[0][0]+=2*Number(r.u2)*Number(r.u2),a[0][1]+=2*Number(r.u2)*Number(r.u4),a[0][2]+=2*Number(r.u2)*Number(r.u6),a[1][0]+=2*Number(r.u4)*Number(r.u2),a[1][1]+=2*Number(r.u4)*Number(r.u4),a[1][2]+=2*Number(r.u4)*Number(r.u6),a[2][0]+=2*Number(r.u6)*Number(r.u2),a[2][1]+=2*Number(r.u6)*Number(r.u4),a[2][2]+=2*Number(r.u6)*Number(r.u6),n[0]+=2*Number(r.u2)*Number(r.sExp),n[1]+=2*Number(r.u4)*Number(r.sExp),n[2]+=2*Number(r.u6)*Number(r.sExp))}let s=math.multiply(math.inv(a),n);e=s[0],o=s[1],i=s[2]}var l="<table class='styled-table' style='width:100%'>",c="data:text/csv;charset=utf-8,Transition eState,Transition gState,Wavelength (nm),(ED),S(MD),A(ED),A(MD),Beta,Lifetime (ms)\n";l+="<thead><tr><th colspan='3'>Transition</th><th>Wavelength (nm)</th><th>S(ED)</th><th>S(MD)</th><th>A(ED)</th><th>A(MD)</th><th>Beta</th><th>Lifetime (ms)</th></tr></thead><tbody>";for(var $=t[0].excitedState,m=0,u=0,g=0,h=[],f=0;f<t.length;f++){let P=ref_REDB.findIndex(e=>e.excitedState==t[f].excitedState),p=ref_REDB.findIndex(e=>e.excitedState==t[f].groundState);if(void 0==P||void 0==p){console.log("State index not found",P,p);continue}let _=formRef.data.dataGrid[P].barycenter,w=formRef.data.dataGrid[p].barycenter;if(void 0==_||void 0==w){console.log("State value not found",_,w);continue}t[f].wavenumber=_-w;let x=Math.sqrt(formRef.data.const_sellmeier+formRef.data.a_sellmeier*math.pow(1e4/t[f].wavenumber,2)/(math.pow(1e4/t[f].wavenumber,2)-formRef.data.b_sellmeier)+formRef.data.c_sellmeier*math.pow(1e4/t[f].wavenumber,2)/(math.pow(1e4/t[f].wavenumber,2)-formRef.data.d_sellmeier)),v=t[f].l2s*math.pow(constE*constH/(4*constPi*constM*constC),2),M=t[f].u2*e+t[f].u4*o+t[f].u6*i,y=64*math.pow(constPi,4)*math.pow(constE,2)/(3*constH),A=y*x*math.pow((x*x+2)/3,2)*M/((2*t[f].eState+1)*math.pow(1/t[f].wavenumber,3)),j=64*math.pow(constPi,4)*math.pow(x,3)*v/(3*constH*math.pow(1/t[f].wavenumber,3)*(2*t[f].eState+1)),b=A+j,S=1e7/t[f].wavenumber;if(h.push({eState:t[f].excitedState,gState:t[f].groundState,wl:S,rowSMD:v,rowSED:M,rowAED:A,rowAMD:j,beta:0,tRad:1e3/b}),$==t[f].excitedState)m+=b,g++;else{u=0;for(var D=0;D<g;D++)u+=h[f-1-D].rowAED+h[f-1-D].rowAMD,h[f-1-D].beta=(h[f-1-D].rowAED+h[f-1-D].rowAMD)/m,h[f-1-D].tRad=1e3/u;m=b,$=t[f].excitedState,g=1}}u=0;for(var D=0;D<g;D++)u+=h[f-1-D].rowAED+h[f-1-D].rowAMD,h[t.length-1-D].beta=(h[t.length-1-D].rowAED+h[t.length-1-D].rowAMD)/m,h[f-1-D].tRad=1e3/u;for(var f=0;f<h.length;f++)c+=h[f].eState+","+h[f].gState+","+h[f].wl.toFixed(1)+","+h[f].rowSED.toPrecision(3)+","+h[f].rowSMD.toPrecision(3)+","+h[f].rowAED.toPrecision(3)+","+h[f].rowAMD.toPrecision(3)+","+h[f].beta.toPrecision(3)+","+h[f].tRad.toPrecision(3)+"\n",l+="<tr><td>"+h[f].eState+"</td><td>-</td><td>"+h[f].gState+"</td><td>"+h[f].wl.toFixed(1)+"</td><td>"+h[f].rowSED.toPrecision(3)+"</td><td>"+h[f].rowSMD.toPrecision(3)+"</td><td>"+h[f].rowAED.toPrecision(3)+"</td><td>"+h[f].rowAMD.toPrecision(3)+"</td><td>"+h[f].beta.toPrecision(3)+"</td><td>"+h[f].tRad.toPrecision(3)+"</td></tr>";l+="</tbody></table>",formRef.getComponent("statTransitionsReport").component.content=l,(linkTransitions=document.createElement("a")).setAttribute("href",encodeURI(c)),""!=formRef.data.sampleName?linkTransitions.setAttribute("download",formRef.data.sampleName+"_transitions_export.csv"):linkTransitions.setAttribute("download","transitions_export.csv"),document.body.appendChild(linkTransitions)}function calcCombinations(){document.getElementById("overlayloading").style.display="block",showProgressBar(),updateProgressBar(progressPercent=10),setTimeout(function(){calcCombinationsWorker()},100)}function calcCombinationsWorker(){let t=0,e="<table class='styled-table' style='width:100%'>",o=ref_REDB.reduce((e,o,i)=>(formRef.data.dataGrid[i].include&&(t++,e.push(i)),e),[]),i=t-1,a=0;if(t>4){let n=new combinationsGen(o),d=0,r="data:text/csv;charset=utf-8,no,transitions_included,transitions_included_no,JO2,JO4,JO6,RMS,lifetime_ms\n";e+="<thead><tr><th></th><th colspan='"+t+"'>Transitions included</th><th>JO2</th><th>JO4</th><th>JO6</th><th>JO2/JO4</th><th>JO2/JO6</th><th>JO4/JO6</th><th>RMS</th><th>Lifetime (ms)</th></tr></thead><tbody>";for(var s=[],l={jo2:[],jo4:[],jo6:[],jo2jo4:[],jo2jo6:[],jo4jo6:[]},c={jo2:[],jo4:[],jo6:[],jo2jo4:[],jo2jo6:[],jo4jo6:[],lifetime:[]},$=0;$<1e10&&!(i<4);)$+=math.factorial(t)/(math.factorial(i)*math.factorial(t-i)),i--;for(progressPercent=0,i=t-1;a<1e10&&!(i<4);){for(a=math.factorial(t)/(math.factorial(i)*math.factorial(t-i)),_combinations=n.combinations(i);;){let m=[];if(0==d)m.value=o;else if((m=_combinations.next()).done)break;d++;let u=Math.round(d/$*30)+10;u>progressPercent&&updateProgressBar(progressPercent=u);let g=[[0,0,0],[0,0,0],[0,0,0]],h=[0,0,0];e=e+"<tr><td>"+d+"</td>";let f=0,P="",p="",_="",w=0;for(let x=0;x<ref_REDB.length;x++)if(m.value.includes(x)){f++;let v=Number(formRef.data.dataGrid[x].u2),M=Number(formRef.data.dataGrid[x].u4),y=Number(formRef.data.dataGrid[x].u6),A=Number(formRef.data.dataGrid[x].sExp);formRef.data.dataGrid[x].sCalc;let j=Number(formRef.data.dataGrid[x].fExp),b=Number(formRef.data.dataGrid[x].fCalc);w+=math.pow(j-b,2),g[0][0]+=2*v*v,g[0][1]+=2*v*M,g[0][2]+=2*v*y,g[1][0]+=2*M*v,g[1][1]+=2*M*M,g[1][2]+=2*M*y,g[2][0]+=2*y*v,g[2][1]+=2*y*M,g[2][2]+=2*y*y,h[0]+=2*v*A,h[1]+=2*M*A,h[2]+=2*y*A,e+=`<td>${ref_REDB[x].excitedStateFormatted}</td>`,P+=`${ref_REDB[x].excitedStateFormatted} `,p+=`${ref_REDB[x].excitedState} `,_+=`${x} `}w=math.sqrt(w/(f-3)),s.push(P);for(let S=0;S<t-f;S++)e+="<td></td>";let D=0,E=!1;try{D=math.multiply(math.inv(g),h)}catch(O){E=!0,console.log(O.message)}if(E||D[0]==NaN||D[1]==NaN||D[2]==NaN)r+=`${d},${p},${_},N/A,N/A,N/A,N/A,N/A
`,e+="<td>N/A</td><td>N/A</td><td>N/A</td><td>N/A</td><td>N/A</td><td>N/A</td><td>N/A</td><td>N/A</td></tr>";else{let B=ref_REDB.findIndex(t=>t.excitedState==ref_REDB_transitions[0].excitedState),I=ref_REDB.findIndex(t=>t.excitedState==ref_REDB_transitions[0].groundState);if(void 0==B||void 0==I){console.log("State index not found",B,I);continue}let N=formRef.data.dataGrid[B].barycenter,J=formRef.data.dataGrid[I].barycenter;if(void 0==N||void 0==J){console.log("State value not found",N,J);continue}ref_REDB_transitions[0].wavenumber=N-J;let G=Math.sqrt(formRef.data.const_sellmeier+formRef.data.a_sellmeier*Math.pow(1e4/ref_REDB_transitions[0].wavenumber,2)/(Math.pow(1e4/ref_REDB_transitions[0].wavenumber,2)-formRef.data.b_sellmeier)+formRef.data.c_sellmeier*Math.pow(1e4/ref_REDB_transitions[0].wavenumber,2)/(Math.pow(1e4/ref_REDB_transitions[0].wavenumber,2)-formRef.data.d_sellmeier)),R=ref_REDB_transitions[0].l2s*math.pow(constE*constH/(4*constPi*constM*constC),2),C=ref_REDB_transitions[0].u2*mtxCacheOutput[0]+ref_REDB_transitions[0].u4*mtxCacheOutput[1]+ref_REDB_transitions[0].u6*mtxCacheOutput[2],T=64*Math.pow(constPi,4)*Math.pow(constE,2)/(3*constH),F=T*G*Math.pow((G*G+2)/3,2)*C/((2*ref_REDB_transitions[0].eState+1)*Math.pow(1/ref_REDB_transitions[0].wavenumber,3)),q=64*Math.pow(constPi,4)*Math.pow(G,3)*R/(3*constH*Math.pow(1/ref_REDB_transitions[0].wavenumber,3)*(2*ref_REDB_transitions[0].eState+1)),k=1e3/(F+q);mtxCacheOutput=D,r+=`${d},${p},${_},${mtxCacheOutput[0]},${mtxCacheOutput[1]},${mtxCacheOutput[2]},${w},${k}
`,c.jo2.push(mtxCacheOutput[0]),c.jo4.push(mtxCacheOutput[1]),c.jo6.push(mtxCacheOutput[2]),c.lifetime.push(k),l.jo2.push({x:d,y:mtxCacheOutput[0]}),l.jo4.push({x:d,y:mtxCacheOutput[1]}),l.jo6.push({x:d,y:mtxCacheOutput[2]}),0!=mtxCacheOutput[1]&&l.jo2jo4.push({x:d,y:mtxCacheOutput[0]/mtxCacheOutput[1]}),0!=mtxCacheOutput[2]&&l.jo2jo6.push({x:d,y:mtxCacheOutput[0]/mtxCacheOutput[2]}),0!=mtxCacheOutput[2]&&l.jo4jo6.push({x:d,y:mtxCacheOutput[1]/mtxCacheOutput[2]}),e+=`<td>${mtxCacheOutput[0].toPrecision(3)}</td><td>${mtxCacheOutput[1].toPrecision(3)}</td><td>${mtxCacheOutput[2].toPrecision(3)}</td><td>${(mtxCacheOutput[0]/mtxCacheOutput[1]).toPrecision(3)}</td><td>${(mtxCacheOutput[0]/mtxCacheOutput[2]).toPrecision(3)}</td><td>${(mtxCacheOutput[1]/mtxCacheOutput[2]).toPrecision(3)}</td><td>${w.toPrecision(3)}</td><td>${k.toPrecision(3)}</td></tr>`}}i--}e+="</tbody></table>",r+="Data used,Median JO2 (cm\xb2),Median JO4 (cm\xb2),Median JO6 (cm\xb2),Median lifetime (ms),Min lifetime (ms),Max lifetime (ms)\n",r+="Full set,"+c.jo2[0].toPrecision(3)+","+c.jo4[0].toPrecision(3)+","+c.jo6[0].toPrecision(3)+","+c.lifetime[0].toPrecision(3)+","+c.lifetime[0].toPrecision(3)+","+c.lifetime[0].toPrecision(3)+"\n",r+="All combinations,"+getMedian(c.jo2).toPrecision(3)+","+getMedian(c.jo4).toPrecision(3)+","+getMedian(c.jo6).toPrecision(3)+","+getMedian(c.lifetime).toPrecision(3)+","+getMin(c.lifetime).toPrecision(3)+","+getMax(c.lifetime).toPrecision(3)+"\n",r+="Reduced (Only positive),"+getMedian(getPositiveArray(c,c.jo2)).toPrecision(3)+","+getMedian(getPositiveArray(c,c.jo4)).toPrecision(3)+","+getMedian(getPositiveArray(c,c.jo6)).toPrecision(3)+","+getMedian(getPositiveArray(c,c.lifetime)).toPrecision(3)+","+getMin(getPositiveArray(c,c.lifetime)).toPrecision(3)+","+getMax(getPositiveArray(c,c.lifetime)).toPrecision(3)+"\n",r+="Reduced (Box plot),"+getMedian(getBoxPlotArray(c,c.jo2)).toPrecision(3)+","+getMedian(getBoxPlotArray(c,c.jo4)).toPrecision(3)+","+getMedian(getBoxPlotArray(c,c.jo6)).toPrecision(3)+","+getMedian(getBoxPlotArray(c,c.lifetime)).toPrecision(3)+","+getMin(getBoxPlotArray(c,c.lifetime)).toPrecision(3)+","+getMax(getBoxPlotArray(c,c.lifetime)).toPrecision(3)+"\n",(linkCombinations=document.createElement("a")).setAttribute("href",encodeURI(r)),""!=formRef.data.sampleName?linkCombinations.setAttribute("download",formRef.data.sampleName+"_optimization_export.csv"):linkCombinations.setAttribute("download","optimization_export.csv"),document.body.appendChild(linkCombinations)}else e="Only 4 options entered",document.getElementById("overlayloading").style.display="none",hideProgressBar();formRef.getComponent("statJOreport").component.content=e,formRef.getComponent("htmldivtablecontainer").component.content="<table style='width:100%; text-align: center;'><thead><tr><th>Datased used</th><th>Median JO2</th><th>Median JO4</th><th>Median JO6</th><th>Median lifetime</th><th>Min lifetime</th><th>Max lifetime</th></tr></thead><tbody><tr><td>Full set</td><td>"+c.jo2[0].toPrecision(3)+" cm\xb2</td><td>"+c.jo4[0].toPrecision(3)+" cm\xb2</td><td>"+c.jo6[0].toPrecision(3)+" cm\xb2</td><td>"+c.lifetime[0].toPrecision(3)+" ms</td><td>"+c.lifetime[0].toPrecision(3)+" ms</td><td>"+c.lifetime[0].toPrecision(3)+" ms</td></tr><tr><td>All combinations</td><td>"+getMedian(c.jo2).toPrecision(3)+" cm\xb2</td><td>"+getMedian(c.jo4).toPrecision(3)+" cm\xb2</td><td>"+getMedian(c.jo6).toPrecision(3)+" cm\xb2</td><td>"+getMedian(c.lifetime).toPrecision(3)+" ms</td><td>"+getMin(c.lifetime).toPrecision(3)+" ms</td><td>"+getMax(c.lifetime).toPrecision(3)+" ms</td></tr><tr><td>Reduced (Only positive)</td><td>"+getMedian(getPositiveArray(c,c.jo2)).toPrecision(3)+" cm\xb2</td><td>"+getMedian(getPositiveArray(c,c.jo4)).toPrecision(3)+" cm\xb2</td><td>"+getMedian(getPositiveArray(c,c.jo6)).toPrecision(3)+" cm\xb2</td><td>"+getMedian(getPositiveArray(c,c.lifetime)).toPrecision(3)+" ms</td><td>"+getMin(getPositiveArray(c,c.lifetime)).toPrecision(3)+" ms</td><td>"+getMax(getPositiveArray(c,c.lifetime)).toPrecision(3)+" ms</td></tr><tr><td>Reduced (Box plot)<i data-tooltip='Box plot median within 1.5 \xd7 25-75 percentile range' class='fa fa-question-circle text-muted' ref='tooltip' aria-expanded='false'></i></td><td>"+getMedian(getBoxPlotArray(c,c.jo2)).toPrecision(3)+" cm\xb2</td><td>"+getMedian(getBoxPlotArray(c,c.jo4)).toPrecision(3)+" cm\xb2</td><td>"+getMedian(getBoxPlotArray(c,c.jo6)).toPrecision(3)+" cm\xb2</td><td>"+getMedian(getBoxPlotArray(c,c.lifetime)).toPrecision(3)+" ms</td><td>"+getMin(getBoxPlotArray(c,c.lifetime)).toPrecision(3)+" ms</td><td>"+getMax(getBoxPlotArray(c,c.lifetime)).toPrecision(3)+" ms</td></tr></tbody></table><br>",formRef.redraw(),setTimeout(function(){progressPercent=40,renderGraph(l,s)},100)}function getStandardDeviation(t){let e=t.length,o=t.reduce((t,e)=>t+e)/e;return Math.sqrt(t.map(t=>Math.pow(t-o,2)).reduce((t,e)=>t+e)/e)}function getAvg(t){let e=t.length;return t.reduce((t,e)=>t+e)/e}function getMin(t){return Math.min(...t)}function getMax(t){return Math.max(...t)}function getMedian(t){let e=t.slice().sort((t,e)=>t-e),o=e.length,i=Math.floor(o/2);return o%2==0?(e[i-1]+e[i])/2:e[i]}function getBoxPlotArray(t,e){let o=getBoxPlotIncorrectIndeces(t.jo2).concat(getBoxPlotIncorrectIndeces(t.jo4),getBoxPlotIncorrectIndeces(t.jo6)),i=e.filter((t,e)=>!o.includes(e));return i}function getPositiveArray(t,e){let o=getNegativeIncorrectIndeces(t.jo2).concat(getNegativeIncorrectIndeces(t.jo4),getNegativeIncorrectIndeces(t.jo6)),i=e.filter((t,e)=>!o.includes(e));return i}function getBoxPlotIncorrectIndeces(t){let e=t.slice().filter(t=>t>=0),o=e.sort((t,e)=>t-e),i=o.length,a=o[Math.ceil(.25*(i-1))],n=o[Math.ceil(.75*(i-1))],d=n-a,r=a-1.5*d<0?0:a-1.5*d,s=n+1.5*d;var l=[];return t.forEach(e=>{(e<r||e>s)&&l.push(t.indexOf(e))}),l}function getNegativeIncorrectIndeces(t){var e=[];return t.forEach(o=>{o<0&&e.push(t.indexOf(o))}),e}class combinationsGen{constructor(t){this.elements=t}*combinations(t,e=!1,o=0,i=[]){let a=this.elements.length;for(let n=o;n<a;n++)i.push(this.elements[n]),i.length===t?yield i:yield*this.combinations(t,e,!0===e?n:n+1,i),i.pop()}}