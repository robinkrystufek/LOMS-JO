function calcTranstions(){let t=ref_REDB_transitions,e=formRef.data.jo2,o=formRef.data.jo4,a=formRef.data.jo6;if("JO"!=formRef.data.radioInputType){let i=[[0,0,0],[0,0,0],[0,0,0]],d=[0,0,0];for(let n=0;n<formRef.data.dataGrid.length;n++){let r=formRef.data.dataGrid[n];r.include&&(i[0][0]+=2*Number(r.u2)*Number(r.u2),i[0][1]+=2*Number(r.u2)*Number(r.u4),i[0][2]+=2*Number(r.u2)*Number(r.u6),i[1][0]+=2*Number(r.u4)*Number(r.u2),i[1][1]+=2*Number(r.u4)*Number(r.u4),i[1][2]+=2*Number(r.u4)*Number(r.u6),i[2][0]+=2*Number(r.u6)*Number(r.u2),i[2][1]+=2*Number(r.u6)*Number(r.u4),i[2][2]+=2*Number(r.u6)*Number(r.u6),d[0]+=2*Number(r.u2)*Number(r.sExp),d[1]+=2*Number(r.u4)*Number(r.sExp),d[2]+=2*Number(r.u6)*Number(r.sExp))}let $=math.multiply(math.inv(i),d);e=$[0],o=$[1],a=$[2]}var l="<table class='styled-table' style='width:100%'>",s="data:text/csv;charset=utf-8,Transition eState,Transition gState,Wavelength (nm),(ED),S(MD),A(ED),A(MD),Beta,Lifetime (ms)\n";l+="<thead><tr><th colspan='3'>Transition</th><th>Wavelength (nm)</th><th>S(ED)</th><th>S(MD)</th><th>A(ED)</th><th>A(MD)</th><th>Beta</th><th>Lifetime (ms)</th></tr></thead><tbody>";for(var c=t[0].excitedState,u=0,_=0,p=0,m=[],h=0;h<t.length;h++){let f=ref_REDB.findIndex(e=>e.excitedState==t[h].excitedState),w=ref_REDB.findIndex(e=>e.excitedState==t[h].groundState);if(void 0==f||void 0==w){console.log("State index not found",f,w);continue}let g=formRef.data.dataGrid[f].barycenter,v=formRef.data.dataGrid[w].barycenter;if(void 0==g||void 0==v){console.log("State value not found",g,v);continue}t[h].wavenumber=g-v;let b=Math.sqrt(formRef.data.const_sellmeier+formRef.data.a_sellmeier*math.pow(1e4/t[h].wavenumber,2)/(math.pow(1e4/t[h].wavenumber,2)-formRef.data.b_sellmeier)+formRef.data.c_sellmeier*math.pow(1e4/t[h].wavenumber,2)/(math.pow(1e4/t[h].wavenumber,2)-formRef.data.d_sellmeier)),x=t[h].l2s*math.pow(constE*constH/(4*constPi*constM*constC),2),j=t[h].u2*e+t[h].u4*o+t[h].u6*a,S=64*math.pow(constPi,4)*math.pow(constE,2)/(3*constH),A=S*b*math.pow((b*b+2)/3,2)*j/((2*t[h].eState+1)*math.pow(1/t[h].wavenumber,3)),P=64*math.pow(constPi,4)*math.pow(b,3)*x/(3*constH*math.pow(1/t[h].wavenumber,3)*(2*t[h].eState+1)),y=A+P,D=1e7/t[h].wavenumber;if(m.push({eState:t[h].excitedState,gState:t[h].groundState,wl:D,rowSMD:x,rowSED:j,rowAED:A,rowAMD:P,beta:0,tRad:1e3/y}),c==t[h].excitedState)u+=y,p++;else{_=0;for(var M=0;M<p;M++)_+=m[h-1-M].rowAED+m[h-1-M].rowAMD,m[h-1-M].beta=(m[h-1-M].rowAED+m[h-1-M].rowAMD)/u,m[h-1-M].tRad=1e3/_;u=y,c=t[h].excitedState,p=1}}_=0;for(var M=0;M<p;M++)_+=m[h-1-M].rowAED+m[h-1-M].rowAMD,m[t.length-1-M].beta=(m[t.length-1-M].rowAED+m[t.length-1-M].rowAMD)/u,m[h-1-M].tRad=1e3/_;for(var h=0;h<m.length;h++)s+=m[h].eState+","+m[h].gState+","+m[h].wl.toFixed(1)+","+m[h].rowSED.toPrecision(3)+","+m[h].rowSMD.toPrecision(3)+","+m[h].rowAED.toPrecision(3)+","+m[h].rowAMD.toPrecision(3)+","+m[h].beta.toPrecision(3)+","+m[h].tRad.toPrecision(3)+"\n",l+="<tr><td>"+m[h].eState+"</td><td>-</td><td>"+m[h].gState+"</td><td>"+m[h].wl.toFixed(1)+"</td><td>"+m[h].rowSED.toPrecision(3)+"</td><td>"+m[h].rowSMD.toPrecision(3)+"</td><td>"+m[h].rowAED.toPrecision(3)+"</td><td>"+m[h].rowAMD.toPrecision(3)+"</td><td>"+m[h].beta.toPrecision(3)+"</td><td>"+m[h].tRad.toPrecision(3)+"</td></tr>";l+="</tbody></table>",formRef.getComponent("statTransitionsReport").component.content=l,(linkTransitions=document.createElement("a")).setAttribute("href",encodeURI(s)),""!=formRef.data.sampleName?linkTransitions.setAttribute("download",formRef.data.sampleName+"_transitions_export.csv"):linkTransitions.setAttribute("download","transitions_export.csv"),document.body.appendChild(linkTransitions)}function calcCombinations(){document.getElementById("overlayloading").style.display="block",showProgressBar(),updateProgressBar(progressPercent=10),setTimeout(function(){calcCombinationsWorker()},100)}function calcCombinationsWorker(){let t=0,e="<table class='styled-table' style='width:100%'>",o=ref_REDB.reduce((e,o,a)=>(formRef.data.dataGrid[a].include&&(t++,e.push(a)),e),[]),a=t-1,i=0;if(t>4){let d=new combinationsGen(o),n=0,r="data:text/csv;charset=utf-8,no,transitions_included,transitions_included_no,JO2,JO4,JO6,RMS,lifetime_ms\n";e+="<thead><tr><th></th><th colspan='"+t+"'>Transitions included</th><th>JO2</th><th>JO4</th><th>JO6</th><th>JO2/JO4</th><th>JO2/JO6</th><th>JO4/JO6</th><th>RMS</th><th>Lifetime (ms)</th></tr></thead><tbody>";for(var $=[],l={jo2:[],jo4:[],jo6:[],jo2jo4:[],jo2jo6:[],jo4jo6:[]},s={jo2:[],jo4:[],jo6:[],jo2jo4:[],jo2jo6:[],jo4jo6:[]},c=0;c<1e10&&!(a<4);)c+=math.factorial(t)/(math.factorial(a)*math.factorial(t-a)),a--;for(progressPercent=0,a=t-1;i<1e10&&!(a<4);){for(i=math.factorial(t)/(math.factorial(a)*math.factorial(t-a)),_combinations=d.combinations(a);;){let u=[];if(0==n)u.value=o;else if((u=_combinations.next()).done)break;n++;let _=Math.round(n/c*30)+10;_>progressPercent&&updateProgressBar(progressPercent=_);let p=[[0,0,0],[0,0,0],[0,0,0]],m=[0,0,0];e=e+"<tr><td>"+n+"</td>";let h=0,f="",w="",g="",v=0;for(let b=0;b<ref_REDB.length;b++)if(u.value.includes(b)){h++;let x=Number(formRef.data.dataGrid[b].u2),j=Number(formRef.data.dataGrid[b].u4),S=Number(formRef.data.dataGrid[b].u6),A=Number(formRef.data.dataGrid[b].sExp),P=Number(formRef.data.dataGrid[b].sCalc);v+=math.pow(A-P,2),p[0][0]+=2*x*x,p[0][1]+=2*x*j,p[0][2]+=2*x*S,p[1][0]+=2*j*x,p[1][1]+=2*j*j,p[1][2]+=2*j*S,p[2][0]+=2*S*x,p[2][1]+=2*S*j,p[2][2]+=2*S*S,m[0]+=2*x*A,m[1]+=2*j*A,m[2]+=2*S*A,e+=`<td>${ref_REDB[b].excitedStateFormatted}</td>`,f+=`${ref_REDB[b].excitedStateFormatted} `,w+=`${ref_REDB[b].excitedState} `,g+=`${b} `}v=math.sqrt(v/(h-3)),$.push(f);for(let y=0;y<t-h;y++)e+="<td></td>";let D=0,M=!1;try{D=math.multiply(math.inv(p),m)}catch(E){M=!0,console.log(E.message)}if(M||D[0]==NaN||D[1]==NaN||D[2]==NaN)r+=`${n},${w},${g},N/A,N/A,N/A,N/A,N/A
`,e+="<td>N/A</td><td>N/A</td><td>N/A</td><td>N/A</td><td>N/A</td><td>N/A</td><td>N/A</td><td>N/A</td></tr>";else{let N=ref_REDB.findIndex(t=>t.excitedState==ref_REDB_transitions[0].excitedState),O=ref_REDB.findIndex(t=>t.excitedState==ref_REDB_transitions[0].groundState);if(void 0==N||void 0==O){console.log("State index not found",N,O);continue}let G=formRef.data.dataGrid[N].barycenter,J=formRef.data.dataGrid[O].barycenter;if(void 0==G||void 0==J){console.log("State value not found",G,J);continue}ref_REDB_transitions[0].wavenumber=G-J;let C=Math.sqrt(formRef.data.const_sellmeier+formRef.data.a_sellmeier*Math.pow(1e4/ref_REDB_transitions[0].wavenumber,2)/(Math.pow(1e4/ref_REDB_transitions[0].wavenumber,2)-formRef.data.b_sellmeier)+formRef.data.c_sellmeier*Math.pow(1e4/ref_REDB_transitions[0].wavenumber,2)/(Math.pow(1e4/ref_REDB_transitions[0].wavenumber,2)-formRef.data.d_sellmeier)),B=ref_REDB_transitions[0].l2s*math.pow(constE*constH/(4*constPi*constM*constC),2),q=ref_REDB_transitions[0].u2*mtxCacheOutput[0]+ref_REDB_transitions[0].u4*mtxCacheOutput[1]+ref_REDB_transitions[0].u6*mtxCacheOutput[2],R=64*Math.pow(constPi,4)*Math.pow(constE,2)/(3*constH),I=R*C*Math.pow((C*C+2)/3,2)*q/((2*ref_REDB_transitions[0].eState+1)*Math.pow(1/ref_REDB_transitions[0].wavenumber,3)),T=64*Math.pow(constPi,4)*Math.pow(C,3)*B/(3*constH*Math.pow(1/ref_REDB_transitions[0].wavenumber,3)*(2*ref_REDB_transitions[0].eState+1)),k=1e3/(I+T);mtxCacheOutput=D,r+=`${n},${w},${g},${mtxCacheOutput[0]},${mtxCacheOutput[1]},${mtxCacheOutput[2]},${v},${k}
`,s.jo2.push(mtxCacheOutput[0]),s.jo4.push(mtxCacheOutput[1]),s.jo6.push(mtxCacheOutput[2]),l.jo2.push({x:n,y:mtxCacheOutput[0]}),l.jo4.push({x:n,y:mtxCacheOutput[1]}),l.jo6.push({x:n,y:mtxCacheOutput[2]}),0!=mtxCacheOutput[1]&&l.jo2jo4.push({x:n,y:mtxCacheOutput[0]/mtxCacheOutput[1]}),0!=mtxCacheOutput[2]&&l.jo2jo6.push({x:n,y:mtxCacheOutput[0]/mtxCacheOutput[2]}),0!=mtxCacheOutput[2]&&l.jo4jo6.push({x:n,y:mtxCacheOutput[1]/mtxCacheOutput[2]}),e+=`<td>${mtxCacheOutput[0].toPrecision(3)}</td><td>${mtxCacheOutput[1].toPrecision(3)}</td><td>${mtxCacheOutput[2].toPrecision(3)}</td><td>${(mtxCacheOutput[0]/mtxCacheOutput[1]).toPrecision(3)}</td><td>${(mtxCacheOutput[0]/mtxCacheOutput[2]).toPrecision(3)}</td><td>${(mtxCacheOutput[1]/mtxCacheOutput[2]).toPrecision(3)}</td><td>${v.toPrecision(3)}</td><td>${k.toPrecision(3)}</td></tr>`}}a--}e+="</tbody></table>",(linkCombinations=document.createElement("a")).setAttribute("href",encodeURI(r)),""!=formRef.data.sampleName?linkCombinations.setAttribute("download",formRef.data.sampleName+"_optimization_export.csv"):linkCombinations.setAttribute("download","optimization_export.csv"),document.body.appendChild(linkCombinations)}else e="Only 4 options entered",document.getElementById("overlayloading").style.display="none",hideProgressBar();formRef.getComponent("statJOreport").component.content=e;let F=["avg: "," cm\xb2 <i data-tooltip='Arithmetic mean' class='fa fa-question-circle text-muted' ref='tooltip' aria-expanded='false'></i>"],W=["median: "," cm\xb2 <i data-tooltip='Median' class='fa fa-question-circle text-muted' ref='tooltip' aria-expanded='false'></i>"],L=["median BP: "," cm\xb2 <i data-tooltip='Box plot median within 1.5 \xd7 25-75 percentile range' class='fa fa-question-circle text-muted' ref='tooltip' aria-expanded='false'></i>"],z=["s.d.: "," cm\xb2 <i data-tooltip='Standard deviation' class='fa fa-question-circle text-muted' ref='tooltip' aria-expanded='false'></i>"],V=["CV: ","% <i data-tooltip='Coefficient of variation' class='fa fa-question-circle text-muted' ref='tooltip' aria-expanded='false'></i>"];formRef.getComponent("htmldivtablecontainer").component.content="<table style='width:100%; text-align: center;'><tr><td>"+F[0]+getAvg(s.jo2).toPrecision(3)+F[1]+"</td><td>"+F[0]+getAvg(s.jo4).toPrecision(3)+F[1]+"</td><td>"+F[0]+getAvg(s.jo6).toPrecision(3)+F[1]+"</td></tr><tr><td>"+W[0]+getMedian(s.jo2).toPrecision(3)+W[1]+"</td><td>"+W[0]+getMedian(s.jo4).toPrecision(3)+W[1]+"</td><td>"+W[0]+getMedian(s.jo6).toPrecision(3)+W[1]+"</td></tr><tr><td>"+L[0]+getMedianBoxPlot(s.jo2).toPrecision(3)+L[1]+"</td><td>"+L[0]+getMedianBoxPlot(s.jo4).toPrecision(3)+L[1]+"</td><td>"+L[0]+getMedianBoxPlot(s.jo6).toPrecision(3)+L[1]+"</td></tr><tr><td>"+z[0]+getStandardDeviation(s.jo2).toPrecision(3)+z[1]+"</td><td>"+z[0]+getStandardDeviation(s.jo4).toPrecision(3)+z[1]+"</td><td>"+z[0]+getStandardDeviation(s.jo6).toPrecision(3)+z[1]+"</td></tr><tr><td>"+V[0]+(getStandardDeviation(s.jo2)/getAvg(s.jo2)*100).toPrecision(3)+V[1]+"</td><td>"+V[0]+(getStandardDeviation(s.jo4)/getAvg(s.jo4)*100).toPrecision(3)+V[1]+"</td><td>"+V[0]+(getStandardDeviation(s.jo6)/getAvg(s.jo6)*100).toPrecision(3)+V[1]+"</td></tr></table><br>",setTimeout(function(){progressPercent=40,renderGraph(l,$)},100)}function getStandardDeviation(t){let e=t.length,o=t.reduce((t,e)=>t+e)/e;return Math.sqrt(t.map(t=>Math.pow(t-o,2)).reduce((t,e)=>t+e)/e)}function getAvg(t){let e=t.length;return t.reduce((t,e)=>t+e)/e}function getMedian(t){let e=t.slice().sort((t,e)=>t-e),o=e.length,a=Math.floor(o/2);return o%2==0?(e[a-1]+e[a])/2:e[a]}function getMedianBoxPlot(t){let e=t.slice().filter(t=>t>=0),o=e.sort((t,e)=>t-e),a=o.length,i=o[Math.ceil(.25*(a-1))],d=o[Math.ceil(.75*(a-1))],n=d-i,r=i-1.5*n<0?0:i-1.5*n,$=d+1.5*n,l=e.filter(t=>t>=r&&t<=$);return getMedian(l)}class combinationsGen{constructor(t){this.elements=t}*combinations(t,e=!1,o=0,a=[]){let i=this.elements.length;for(let d=o;d<i;d++)a.push(this.elements[d]),a.length===t?yield a:yield*this.combinations(t,e,!0===e?d:d+1,a),a.pop()}}