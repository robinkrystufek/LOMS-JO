function calcTranstions(){let t=ref_REDB_transitions,e=formRef.data.jo2,o=formRef.data.jo4,i=formRef.data.jo6;if("JO"!=formRef.data.radioInputType){let r=[[0,0,0],[0,0,0],[0,0,0]],a=[0,0,0];for(let n=0;n<formRef.data.dataGrid.length;n++){let d=formRef.data.dataGrid[n];d.include&&(r[0][0]+=2*Number(d.u2)*Number(d.u2),r[0][1]+=2*Number(d.u2)*Number(d.u4),r[0][2]+=2*Number(d.u2)*Number(d.u6),r[1][0]+=2*Number(d.u4)*Number(d.u2),r[1][1]+=2*Number(d.u4)*Number(d.u4),r[1][2]+=2*Number(d.u4)*Number(d.u6),r[2][0]+=2*Number(d.u6)*Number(d.u2),r[2][1]+=2*Number(d.u6)*Number(d.u4),r[2][2]+=2*Number(d.u6)*Number(d.u6),a[0]+=2*Number(d.u2)*Number(d.sExp),a[1]+=2*Number(d.u4)*Number(d.sExp),a[2]+=2*Number(d.u6)*Number(d.sExp))}let s=math.multiply(math.inv(r),a);e=s[0],o=s[1],i=s[2]}var l="<table class='styled-table' style='width:100%'>",c="data:text/csv;charset=utf-8,Transition eState,Transition gState,Wavelength (nm),(ED),S(MD),A(ED),A(MD),Beta,Lifetime (ms)\n";l+="<thead><tr><th colspan='3'>Transition</th><th>Wavelength (nm)</th><th>S(ED)</th><th>S(MD)</th><th>A(ED)</th><th>A(MD)</th><th>Beta</th><th>Lifetime (ms)</th></tr></thead><tbody>";for(var $=t[0].excitedState,u=0,m=0,g=0,f=[],h=0;h<t.length;h++){let P=ref_REDB.findIndex(e=>e.excitedState==t[h].excitedState),p=ref_REDB.findIndex(e=>e.excitedState==t[h].groundState);if(void 0==P||void 0==p){console.log("State index not found",P,p);continue}let _=formRef.data.dataGrid[P].barycenter,w=formRef.data.dataGrid[p].barycenter;if(void 0==_||void 0==w){console.log("State value not found",_,w);continue}t[h].wavenumber=_-w;let x=Math.sqrt(formRef.data.const_sellmeier+formRef.data.a_sellmeier*math.pow(1e4/t[h].wavenumber,2)/(math.pow(1e4/t[h].wavenumber,2)-formRef.data.b_sellmeier)+formRef.data.c_sellmeier*math.pow(1e4/t[h].wavenumber,2)/(math.pow(1e4/t[h].wavenumber,2)-formRef.data.d_sellmeier)),v=t[h].l2s*math.pow(constE*constH/(4*constPi*constM*constC),2),M=t[h].u2*e+t[h].u4*o+t[h].u6*i,y=64*math.pow(constPi,4)*math.pow(constE,2)/(3*constH),b=y*x*math.pow((x*x+2)/3,2)*M/((2*t[h].eState+1)*math.pow(1/t[h].wavenumber,3)),A=64*math.pow(constPi,4)*math.pow(x,3)*v/(3*constH*math.pow(1/t[h].wavenumber,3)*(2*t[h].eState+1)),j=b+A,S=1e7/t[h].wavenumber;if(f.push({eState:t[h].excitedState,gState:t[h].groundState,wl:S,rowSMD:v,rowSED:M,rowAED:b,rowAMD:A,beta:0,tRad:1e3/j}),$==t[h].excitedState)u+=j,g++;else{m=0;for(var D=0;D<g;D++)m+=f[h-1-D].rowAED+f[h-1-D].rowAMD,f[h-1-D].beta=(f[h-1-D].rowAED+f[h-1-D].rowAMD)/u,f[h-1-D].tRad=1e3/m;u=j,$=t[h].excitedState,g=1}}m=0;for(var D=0;D<g;D++)m+=f[h-1-D].rowAED+f[h-1-D].rowAMD,f[t.length-1-D].beta=(f[t.length-1-D].rowAED+f[t.length-1-D].rowAMD)/u,f[h-1-D].tRad=1e3/m;for(var h=0;h<f.length;h++)c+=f[h].eState+","+f[h].gState+","+f[h].wl.toFixed(1)+","+f[h].rowSED.toPrecision(3)+","+f[h].rowSMD.toPrecision(3)+","+f[h].rowAED.toPrecision(3)+","+f[h].rowAMD.toPrecision(3)+","+f[h].beta.toPrecision(3)+","+f[h].tRad.toPrecision(3)+"\n",l+="<tr><td>"+f[h].eState+"</td><td>-</td><td>"+f[h].gState+"</td><td>"+f[h].wl.toFixed(1)+"</td><td>"+f[h].rowSED.toPrecision(3)+"</td><td>"+f[h].rowSMD.toPrecision(3)+"</td><td>"+f[h].rowAED.toPrecision(3)+"</td><td>"+f[h].rowAMD.toPrecision(3)+"</td><td>"+f[h].beta.toPrecision(3)+"</td><td>"+f[h].tRad.toPrecision(3)+"</td></tr>";l+="</tbody></table>",formRef.getComponent("statTransitionsReport").component.content=l,(linkTransitions=document.createElement("a")).setAttribute("href",encodeURI(c)),""!=formRef.data.sampleName?linkTransitions.setAttribute("download",formRef.data.sampleName+"_transitions_export.csv"):linkTransitions.setAttribute("download","transitions_export.csv"),document.body.appendChild(linkTransitions)}function calcCombinations(){document.getElementById("overlayloading").style.display="block",showProgressBar(),updateProgressBar(progressPercent=10),setTimeout(function(){calcCombinationsWorker()},100)}function calcCombinationsWorker(){let t=0,e="<table class='styled-table' style='width:100%'>",o=ref_REDB.reduce((e,o,i)=>(formRef.data.dataGrid[i].include&&(t++,e.push(i)),e),[]),i=t-1,r=0;if(t>4){let a=new combinationsGen(o),n=0,d="data:text/csv;charset=utf-8,no,transitions_included,transitions_included_no,JO2,JO4,JO6,RMSF,RMSS,lifetime_ms,error_JO2,error_JO4,error_JO6\n";e+="<thead><tr><th></th><th colspan='"+t+"'>Transitions included</th><th>JO2</th><th>JO4</th><th>JO6</th><th>JO2/JO4</th><th>JO2/JO6</th><th>JO4/JO6</th><th>RMS<sub>S</sub></th><th>RMS<sub>F</sub></th><th>Lifetime (ms)</th></tr></thead><tbody>";for(var s=[],l={jo2:[],jo4:[],jo6:[],jo2jo4:[],jo2jo6:[],jo4jo6:[]},c={jo2:[],jo4:[],jo6:[],jo2jo4:[],jo2jo6:[],jo4jo6:[],lifetime:[]},$=0;$<1e10&&!(i<4);)$+=math.factorial(t)/(math.factorial(i)*math.factorial(t-i)),i--;for(progressPercent=0,i=t-1;r<1e10&&!(i<4);){for(r=math.factorial(t)/(math.factorial(i)*math.factorial(t-i)),_combinations=a.combinations(i);;){let u=[];if(0==n)u.value=o;else if((u=_combinations.next()).done)break;n++;let m=Math.round(n/$*30)+10;m>progressPercent&&updateProgressBar(progressPercent=m);let g=[[0,0,0],[0,0,0],[0,0,0]],f=[0,0,0];e=e+"<tr><td>"+n+"</td>";let h=0,P="",p="",_="",w=0,x=0,v=[];for(let M=0;M<ref_REDB.length;M++)if(u.value.includes(M)){let y=Number(formRef.data.dataGrid[M].u2),b=Number(formRef.data.dataGrid[M].u4),A=Number(formRef.data.dataGrid[M].u6),j=Number(formRef.data.dataGrid[M].sExp),S=Number(formRef.data.dataGrid[M].sCalc),D=Number(formRef.data.dataGrid[M].fExp),E=Number(formRef.data.dataGrid[M].fCalc);w+=math.pow(D-E,2),x+=math.pow(j-S,2),g[0][0]+=2*y*y,g[0][1]+=2*y*b,g[0][2]+=2*y*A,g[1][0]+=2*b*y,g[1][1]+=2*b*b,g[1][2]+=2*b*A,g[2][0]+=2*A*y,g[2][1]+=2*A*b,g[2][2]+=2*A*A,f[0]+=2*y*j,f[1]+=2*b*j,f[2]+=2*A*j,v[h]=[],v[h][0]=y,v[h][1]=b,v[h][2]=A,e+=`<td>${ref_REDB[M].excitedStateFormatted}</td>`,P+=`${ref_REDB[M].excitedStateFormatted} `,p+=`${ref_REDB[M].excitedState} `,_+=`${M} `,h++}w=math.sqrt(w/(h-3)),x=math.sqrt(x/(h-3)),s.push(P);for(let O=0;O<t-h;O++)e+="<td></td>";let B=0,J=!1;try{B=math.multiply(math.inv(g),f)}catch(I){J=!0,console.log(I.message)}if(J||B[0]==NaN||B[1]==NaN||B[2]==NaN)d+=`${n},${p},${_},N/A,N/A,N/A,N/A,N/A
`,e+="<td>N/A</td><td>N/A</td><td>N/A</td><td>N/A</td><td>N/A</td><td>N/A</td><td>N/A</td><td>N/A</td></tr>";else{let G=ref_REDB.findIndex(t=>t.excitedState==ref_REDB_transitions[0].excitedState),N=ref_REDB.findIndex(t=>t.excitedState==ref_REDB_transitions[0].groundState);if(void 0==G||void 0==N){console.log("State index not found",G,N);continue}let R=formRef.data.dataGrid[G].barycenter,q=formRef.data.dataGrid[N].barycenter;if(void 0==R||void 0==q){console.log("State value not found",R,q);continue}ref_REDB_transitions[0].wavenumber=R-q;let C=Math.sqrt(formRef.data.const_sellmeier+formRef.data.a_sellmeier*Math.pow(1e4/ref_REDB_transitions[0].wavenumber,2)/(Math.pow(1e4/ref_REDB_transitions[0].wavenumber,2)-formRef.data.b_sellmeier)+formRef.data.c_sellmeier*Math.pow(1e4/ref_REDB_transitions[0].wavenumber,2)/(Math.pow(1e4/ref_REDB_transitions[0].wavenumber,2)-formRef.data.d_sellmeier)),F=ref_REDB_transitions[0].l2s*math.pow(constE*constH/(4*constPi*constM*constC),2),W=ref_REDB_transitions[0].u2*mtxCacheOutput[0]+ref_REDB_transitions[0].u4*mtxCacheOutput[1]+ref_REDB_transitions[0].u6*mtxCacheOutput[2],T=64*Math.pow(constPi,4)*Math.pow(constE,2)/(3*constH),k=T*C*Math.pow((C*C+2)/3,2)*W/((2*ref_REDB_transitions[0].eState+1)*Math.pow(1/ref_REDB_transitions[0].wavenumber,3)),L=64*Math.pow(constPi,4)*Math.pow(C,3)*F/(3*constH*Math.pow(1/ref_REDB_transitions[0].wavenumber,3)*(2*ref_REDB_transitions[0].eState+1)),z=1e3/(k+L);mtxCacheOutput=B;let H=math.inv(math.multiply(math.transpose(v),v));d+=`${n},${p},${_},${mtxCacheOutput[0]},${mtxCacheOutput[1]},${mtxCacheOutput[2]},${w},${x},${z},${math.sqrt(H[0][0])*x},${math.sqrt(H[1][1])*x},${math.sqrt(H[2][2])*x}
`,c.jo2.push(mtxCacheOutput[0]),c.jo4.push(mtxCacheOutput[1]),c.jo6.push(mtxCacheOutput[2]),c.lifetime.push(z),l.jo2.push({x:n,y:mtxCacheOutput[0]}),l.jo4.push({x:n,y:mtxCacheOutput[1]}),l.jo6.push({x:n,y:mtxCacheOutput[2]}),0!=mtxCacheOutput[1]&&l.jo2jo4.push({x:n,y:mtxCacheOutput[0]/mtxCacheOutput[1]}),0!=mtxCacheOutput[2]&&l.jo2jo6.push({x:n,y:mtxCacheOutput[0]/mtxCacheOutput[2]}),0!=mtxCacheOutput[2]&&l.jo4jo6.push({x:n,y:mtxCacheOutput[1]/mtxCacheOutput[2]}),e+=`<td>${formatWithError(mtxCacheOutput[0],math.sqrt(H[0][0])*x)}</td><td>${formatWithError(mtxCacheOutput[1],math.sqrt(H[1][1])*x)}</td><td>${formatWithError(mtxCacheOutput[2],math.sqrt(H[2][2])*x)}</td><td>${(mtxCacheOutput[0]/mtxCacheOutput[1]).toPrecision(3)}</td><td>${(mtxCacheOutput[0]/mtxCacheOutput[2]).toPrecision(3)}</td><td>${(mtxCacheOutput[1]/mtxCacheOutput[2]).toPrecision(3)}</td><td>${x.toPrecision(3)}</td><td>${w.toPrecision(3)}</td><td>${z.toPrecision(3)}</td></tr>`}}i--}e+="</tbody></table>",d+="Data used,Median JO2 (cm\xb2),Median JO4 (cm\xb2),Median JO6 (cm\xb2),Median lifetime (ms),Min lifetime (ms),Max lifetime (ms)\n",d+="Full set,"+c.jo2[0].toPrecision(3)+","+c.jo4[0].toPrecision(3)+","+c.jo6[0].toPrecision(3)+","+c.lifetime[0].toPrecision(3)+","+c.lifetime[0].toPrecision(3)+","+c.lifetime[0].toPrecision(3)+"\n",d+="All combinations,"+getMedian(c.jo2).toPrecision(3)+","+getMedian(c.jo4).toPrecision(3)+","+getMedian(c.jo6).toPrecision(3)+","+getMedian(c.lifetime).toPrecision(3)+","+getMin(c.lifetime).toPrecision(3)+","+getMax(c.lifetime).toPrecision(3)+"\n",d+="Reduced (Only positive),"+getMedian(getPositiveArray(c,c.jo2)).toPrecision(3)+","+getMedian(getPositiveArray(c,c.jo4)).toPrecision(3)+","+getMedian(getPositiveArray(c,c.jo6)).toPrecision(3)+","+getMedian(getPositiveArray(c,c.lifetime)).toPrecision(3)+","+getMin(getPositiveArray(c,c.lifetime)).toPrecision(3)+","+getMax(getPositiveArray(c,c.lifetime)).toPrecision(3)+"\n",d+="Reduced (Box plot),"+getMedian(getBoxPlotArray(c,c.jo2)).toPrecision(3)+","+getMedian(getBoxPlotArray(c,c.jo4)).toPrecision(3)+","+getMedian(getBoxPlotArray(c,c.jo6)).toPrecision(3)+","+getMedian(getBoxPlotArray(c,c.lifetime)).toPrecision(3)+","+getMin(getBoxPlotArray(c,c.lifetime)).toPrecision(3)+","+getMax(getBoxPlotArray(c,c.lifetime)).toPrecision(3)+"\n",(linkCombinations=document.createElement("a")).setAttribute("href",encodeURI(d)),""!=formRef.data.sampleName?linkCombinations.setAttribute("download",formRef.data.sampleName+"_optimization_export.csv"):linkCombinations.setAttribute("download","optimization_export.csv"),document.body.appendChild(linkCombinations)}else e="Only 4 options entered",document.getElementById("overlayloading").style.display="none",hideProgressBar();formRef.getComponent("statJOreport").component.content=e,formRef.getComponent("htmldivtablecontainer").component.content="<table style='width:100%; text-align: center;'><thead><tr><th>Datased used</th><th>Median JO2</th><th>Median JO4</th><th>Median JO6</th><th>Median lifetime</th><th>Min lifetime</th><th>Max lifetime</th></tr></thead><tbody><tr><td>Full set</td><td>"+c.jo2[0].toPrecision(3)+" cm\xb2</td><td>"+c.jo4[0].toPrecision(3)+" cm\xb2</td><td>"+c.jo6[0].toPrecision(3)+" cm\xb2</td><td>"+c.lifetime[0].toPrecision(3)+" ms</td><td>"+c.lifetime[0].toPrecision(3)+" ms</td><td>"+c.lifetime[0].toPrecision(3)+" ms</td></tr><tr><td>All combinations</td><td>"+getMedian(c.jo2).toPrecision(3)+" cm\xb2</td><td>"+getMedian(c.jo4).toPrecision(3)+" cm\xb2</td><td>"+getMedian(c.jo6).toPrecision(3)+" cm\xb2</td><td>"+getMedian(c.lifetime).toPrecision(3)+" ms</td><td>"+getMin(c.lifetime).toPrecision(3)+" ms</td><td>"+getMax(c.lifetime).toPrecision(3)+" ms</td></tr><tr><td>Reduced (Only positive)</td><td>"+getMedian(getPositiveArray(c,c.jo2)).toPrecision(3)+" cm\xb2</td><td>"+getMedian(getPositiveArray(c,c.jo4)).toPrecision(3)+" cm\xb2</td><td>"+getMedian(getPositiveArray(c,c.jo6)).toPrecision(3)+" cm\xb2</td><td>"+getMedian(getPositiveArray(c,c.lifetime)).toPrecision(3)+" ms</td><td>"+getMin(getPositiveArray(c,c.lifetime)).toPrecision(3)+" ms</td><td>"+getMax(getPositiveArray(c,c.lifetime)).toPrecision(3)+" ms</td></tr><tr><td>Reduced (Box plot)<i data-tooltip='Box plot median within 1.5 \xd7 25-75 percentile range' class='fa fa-question-circle text-muted' ref='tooltip' aria-expanded='false'></i></td><td>"+getMedian(getBoxPlotArray(c,c.jo2)).toPrecision(3)+" cm\xb2</td><td>"+getMedian(getBoxPlotArray(c,c.jo4)).toPrecision(3)+" cm\xb2</td><td>"+getMedian(getBoxPlotArray(c,c.jo6)).toPrecision(3)+" cm\xb2</td><td>"+getMedian(getBoxPlotArray(c,c.lifetime)).toPrecision(3)+" ms</td><td>"+getMin(getBoxPlotArray(c,c.lifetime)).toPrecision(3)+" ms</td><td>"+getMax(getBoxPlotArray(c,c.lifetime)).toPrecision(3)+" ms</td></tr></tbody></table><br>",formRef.redraw(),setTimeout(function(){progressPercent=40,renderGraph(l,s)},100)}function calculateErrorJO(t,e){if(t.dataGrid.filter(t=>t.include).length<4)return NaN;var o=0,i=[];for(let r=0;r<t.dataGrid.length;r++)t.dataGrid[r].include&&(i[o]=[],i[o][0]=Number(t.dataGrid[r].u2),i[o][1]=Number(t.dataGrid[r].u4),i[o][2]=Number(t.dataGrid[r].u6),o++);let a=math.inv(math.multiply(math.transpose(i),i));return math.sqrt(a[e][e])*t.joRMSS}function formatWithError(t,e){if(0===t)return`0 \xb1 ${e}`;let o=Math.floor(Math.log10(Math.abs(t))),i=Number((t/Math.pow(10,o)).toPrecision(3)).toString(),r=Number((e/Math.pow(10,o)).toPrecision(3)).toString();return r>i?`<i style='color:#dc3545;'>${i} \xb1 ${r} e${o}</i>`:`${i} \xb1 ${r} e${o}`}function getStandardDeviation(t){let e=t.length,o=t.reduce((t,e)=>t+e)/e;return Math.sqrt(t.map(t=>Math.pow(t-o,2)).reduce((t,e)=>t+e)/e)}function getAvg(t){let e=t.length;return t.reduce((t,e)=>t+e)/e}function getMin(t){return Math.min(...t)}function getMax(t){return Math.max(...t)}function getMedian(t){let e=t.slice().sort((t,e)=>t-e),o=e.length,i=Math.floor(o/2);return o%2==0?(e[i-1]+e[i])/2:e[i]}function getBoxPlotArray(t,e){let o=getBoxPlotIncorrectIndeces(t.jo2).concat(getBoxPlotIncorrectIndeces(t.jo4),getBoxPlotIncorrectIndeces(t.jo6)),i=e.filter((t,e)=>!o.includes(e));return i}function getPositiveArray(t,e){let o=getNegativeIncorrectIndeces(t.jo2).concat(getNegativeIncorrectIndeces(t.jo4),getNegativeIncorrectIndeces(t.jo6)),i=e.filter((t,e)=>!o.includes(e));return i}function getBoxPlotIncorrectIndeces(t){let e=t.slice().filter(t=>t>=0),o=e.sort((t,e)=>t-e),i=o.length,r=o[Math.ceil(.25*(i-1))],a=o[Math.ceil(.75*(i-1))],n=a-r,d=r-1.5*n<0?0:r-1.5*n,s=a+1.5*n;var l=[];return t.forEach(e=>{(e<d||e>s)&&l.push(t.indexOf(e))}),l}function getNegativeIncorrectIndeces(t){var e=[];return t.forEach(o=>{o<0&&e.push(t.indexOf(o))}),e}class combinationsGen{constructor(t){this.elements=t}*combinations(t,e=!1,o=0,i=[]){let r=this.elements.length;for(let a=o;a<r;a++)i.push(this.elements[a]),i.length===t?yield i:yield*this.combinations(t,e,!0===e?a:a+1,i),i.pop()}}