function toggleSignIn(){if(firebase.auth().currentUser)firebase.auth().signOut();else{var e=document.getElementById("email").value,t=document.getElementById("password").value;if(e.length<4){alert("Please enter an email address.");return}if(t.length<4){alert("Please enter a password.");return}firebase.auth().signInWithEmailAndPassword(e,t).catch(function(e){var t=e.code,n=e.message;"auth/wrong-password"===t?alert("Incorrect password."):alert(n),console.log(e),document.getElementById("login-widget-sign-in").disabled=!1})}}function handleSignUp(){var e=document.getElementById("email").value,t=document.getElementById("password").value;if(e.length<4){alert("Please enter an email address.");return}if(t.length<4){alert("Please enter a password.");return}var n=document.getElementById("displayaffiliation").value,i=document.getElementById("displayname").value,a=document.getElementById("displayorcid").value;if(""==n&&""==i){document.getElementById("userinfoextended").style.display="block",policyAgreementChange();return}if(n.length<2){alert("Please enter your affiliation.");return}if(i.length<2){alert("Please enter your name.");return}firebase.auth().createUserWithEmailAndPassword(e,t).then(e=>{e.user.updateProfile({displayName:i,photoURL:n+";"+a}).then(()=>{console.log("Updated user info: "+i+" "+n),document.getElementById("displayaffiliation").value="",document.getElementById("displayname").value=""}).catch(e=>{console.log("Error updating user info: "+i+" "+n)}),e.user.sendEmailVerification(),firebase.auth().signOut(),document.getElementById("userinfoextended").style.display="none"}).catch(function(e){var t=e.code,n=e.message;"auth/weak-password"==t?alert("The password is too weak."):alert(n),console.log(e)})}function sendPasswordReset(){var e=document.getElementById("email").value;firebase.auth().sendPasswordResetEmail(e).then(function(){alert("Password Reset Email Sent!")}).catch(function(e){var t=e.code,n=e.message;"auth/invalid-email"==t?alert(n):"auth/user-not-found"==t&&alert(n),console.log(e)})}function deleteAccount(){firebase.auth().currentUser.delete().then(function(){alert("Account deleted successfully."),document.getElementById("loggedin-area-edit").style.display="none",document.getElementById("loggedin-area").style.display="block",document.getElementById("login-signup-area").style.display="none",userLoggedIn=!1,formRef.triggerChange(),document.getElementById("login-info-user").textContent="Anonymous user",document.getElementById("login-widget-sign-up").disabled=!1,document.getElementById("login-widget-sign-in").textContent="Sign in",document.getElementById("login-signup-area").style.display="block",document.getElementById("loggedin-area").style.display="none",document.getElementById("loggedin-area-name").textContent="",document.getElementById("loggedin-area-email").textContent="",document.getElementById("loggedin-area-affiliation").textContent=""}).catch(function(e){console.log(e),alert("Error deleting account.")})}function sendPasswordReset2(){var e=document.getElementById("loggedin-area-email").textContent;firebase.auth().sendPasswordResetEmail(e).then(function(){alert("Password Reset Email Sent!")}).catch(function(e){var t=e.code,n=e.message;"auth/invalid-email"==t?alert(n):"auth/user-not-found"==t&&alert(n),console.log(e)})}function editProfileShow(){document.getElementById("displaynameedit").value=firebase.auth().currentUser.displayName,null!=firebase.auth().currentUser.photoURL&&-1!=firebase.auth().currentUser.photoURL.search(";")&&(document.getElementById("displayaffiliationedit").value=firebase.auth().currentUser.photoURL.split(";")[0],document.getElementById("displayorcidedit").value=firebase.auth().currentUser.photoURL.split(";")[1]),document.getElementById("loggedin-area-edit").style.display="block",document.getElementById("loggedin-area").style.display="none",document.getElementById("login-signup-area").style.display="none"}function editProfileSave(){uname=document.getElementById("displaynameedit").value,uaffiliation=document.getElementById("displayaffiliationedit").value.replace(";",""),orcid=document.getElementById("displayorcidedit").value,firebase.auth().currentUser.updateProfile({displayName:uname,photoURL:uaffiliation+";"+orcid}).then(()=>{console.log("Updated user info: "+uname+" "+uaffiliation),document.getElementById("loggedin-area-name").textContent=uname,document.getElementById("loggedin-area-affiliation").textContent=uaffiliation,document.getElementById("loggedin-area-orcid").textContent=orcid,document.getElementById("loggedin-area-edit").style.display="none",document.getElementById("loggedin-area").style.display="block",document.getElementById("login-signup-area").style.display="none",alert("Update successful")}).catch(e=>{console.log("Error updating user info: "+uname+" "+uaffiliation),alert("Error updating user info: "+uname+" "+uaffiliation)})}function orcidEditChange(){""!=document.getElementById("displayorcidedit").value&&(/^\d{4}-\d{4}-\d{4}-\d{4}$/.test(document.getElementById("displayorcidedit").value)?fetchXMLFromURL("https://pub.orcid.org/v3.0/expanded-search/?start=0&rows=1&q=orcid:"+document.getElementById("displayorcidedit").value):(document.getElementById("displayaffiliationedit").disabled=!1,document.getElementById("displaynameedit").disabled=!1))}function orcidNewChange(){""!=document.getElementById("displayorcid").value&&(/^\d{4}-\d{4}-\d{4}-\d{4}$/.test(document.getElementById("displayorcid").value)?fetchXMLFromURL("https://pub.orcid.org/v3.0/expanded-search/?start=0&rows=1&q=orcid:"+document.getElementById("displayorcid").value):(document.getElementById("displayaffiliation").disabled=!1,document.getElementById("displayname").disabled=!1))}function fetchXMLFromURL(e){fetch(e).then(e=>e.text()).then(e=>{let t=new DOMParser,n=t.parseFromString(e,"text/xml"),i=n.getElementsByTagName("expanded-search:expanded-search");console.log(e),console.log(i),i&&parseInt(i[0].getAttribute("num-found"))>0?(console.log("num-found is greater than 0"),document.getElementById("displaynameedit").value=i[0].getElementsByTagName("expanded-search:given-names")[0].textContent+" "+i[0].getElementsByTagName("expanded-search:family-names")[0].textContent,document.getElementById("displayaffiliationedit").value=i[0].getElementsByTagName("expanded-search:institution-name")[i[0].getElementsByTagName("expanded-search:institution-name").length-1].textContent,document.getElementById("displayaffiliationedit").disabled=!0,document.getElementById("displaynameedit").disabled=!0,document.getElementById("displayname").value=i[0].getElementsByTagName("expanded-search:given-names")[0].textContent+" "+i[0].getElementsByTagName("expanded-search:family-names")[0].textContent,document.getElementById("displayaffiliation").value=i[0].getElementsByTagName("expanded-search:institution-name")[i[0].getElementsByTagName("expanded-search:institution-name").length-1].textContent,document.getElementById("displayaffiliation").disabled=!0,document.getElementById("displayname").disabled=!0):(console.log("num-found is not greater than 0"),document.getElementById("displayaffiliationedit").disabled=!1,document.getElementById("displaynameedit").disabled=!1,document.getElementById("displayaffiliation").disabled=!1,document.getElementById("displayname").disabled=!1)}).catch(e=>{console.error("Error fetching XML:",e),document.getElementById("displayaffiliationedit").disabled=!1,document.getElementById("displaynameedit").disabled=!1,document.getElementById("displayaffiliation").disabled=!1,document.getElementById("displayname").disabled=!1})}function policyAgreementChange(){document.getElementById("policyagreement").checked?document.getElementById("login-widget-sign-up").disabled=!1:document.getElementById("login-widget-sign-up").disabled=!0}function initApp(){document.getElementById("login-widget-sign-in").disabled=!1,firebase.auth().onAuthStateChanged(function(e){if(e){if(!e.emailVerified){document.getElementById("login-notice").textContent="Check inbox for activation link",document.getElementById("login-widget-password-reset").textContent="",setTimeout(()=>{document.getElementById("login-notice").textContent="",document.getElementById("login-widget-password-reset").textContent="Reset password"},5e3),firebase.auth().signOut();return}var t=e.displayName,n=e.email,i=e.photoURL;userLoggedIn=!0,formRef.triggerChange(),document.getElementById("login-signup-area").style.display="none",document.getElementById("loggedin-area").style.display="block",document.getElementById("loggedin-area-name").textContent=t,document.getElementById("loggedin-area-email").textContent=n,null!=i&&-1!=i.search(";")&&(document.getElementById("loggedin-area-affiliation").textContent=i.split(";")[0],document.getElementById("loggedin-area-orcid").textContent=i.split(";")[1]),document.getElementById("login-notice").textContent="",document.getElementById("login-info-user").textContent=n,document.getElementById("login-widget-sign-up").disabled=!0,document.getElementById("login-widget-sign-in").textContent="Sign out"}else userLoggedIn=!1,formRef.triggerChange(),document.getElementById("login-info-user").textContent="Anonymous user",document.getElementById("login-widget-sign-up").disabled=!1,document.getElementById("login-widget-sign-in").textContent="Sign in",document.getElementById("login-signup-area").style.display="block",document.getElementById("loggedin-area").style.display="none",document.getElementById("loggedin-area-name").textContent="",document.getElementById("loggedin-area-email").textContent="",document.getElementById("loggedin-area-affiliation").textContent="";document.getElementById("login-widget-sign-in").disabled=!1}),document.getElementById("login-widget-sign-out").addEventListener("click",toggleSignIn,!1),document.getElementById("login-widget-sign-in").addEventListener("click",toggleSignIn,!1),document.getElementById("login-widget-sign-up").addEventListener("click",handleSignUp,!1),document.getElementById("login-widget-password-reset").addEventListener("click",sendPasswordReset,!1),document.getElementById("login-widget-reset-pass2").addEventListener("click",sendPasswordReset2,!1),document.getElementById("login-widget-change-profile").addEventListener("click",editProfileShow,!1),document.getElementById("login-widget-change-profile-save").addEventListener("click",editProfileSave,!1),document.getElementById("displayorcidedit").addEventListener("change",orcidEditChange,!1),document.getElementById("displayorcid").addEventListener("change",orcidNewChange,!1),document.getElementById("login-widget-delete-account").addEventListener("click",deleteAccount,!1),document.getElementById("policyagreement").addEventListener("change",policyAgreementChange,!1)}window.onload=function(){initApp()};